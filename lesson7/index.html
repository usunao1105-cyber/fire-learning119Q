<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>交通救助メモ</title>
    
    <!-- Tailwind CSS (Design) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel (JSX Compiler) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        /* スマホでのタップ操作を快適にするための調整 */
        body {
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }
        /* iOSでの入力ズーム防止 */
        input, select, textarea {
            font-size: 16px !important; 
        }
    </style>
</head>
<body class="bg-slate-900 text-slate-100">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // --- Icons (SVG Components) ---
        const IconBase = ({ children, className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                {children}
            </svg>
        );

        const Car = ({ className }) => (
            <IconBase className={className}>
                <path d="M19 17h2c.6 0 1-.4 1-1v-3c0-.9-.7-1.7-1.5-1.9C18.7 10.6 16 10 16 10s-1.3-1.4-2.2-2.3c-.5-.4-1.1-.7-1.8-.7H5c-.6 0-1.1.4-1.4.9l-1.4 2.9A3.7 3.7 0 0 0 2 12v4c0 .6.4 1 1 1h2" />
                <circle cx="7" cy="17" r="2" />
                <circle cx="17" cy="17" r="2" />
                <path d="M14 17H9" />
            </IconBase>
        );
        const User = ({ className }) => (
            <IconBase className={className}>
                <path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2" />
                <circle cx="12" cy="7" r="4" />
            </IconBase>
        );
        const Trash2 = ({ className }) => (
            <IconBase className={className}>
                <path d="M3 6h18" />
                <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6" />
                <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2" />
                <line x1="10" x2="10" y1="11" y2="17" />
                <line x1="14" x2="14" y1="11" y2="17" />
            </IconBase>
        );
        const Plus = ({ className }) => (
            <IconBase className={className}>
                <path d="M5 12h14" />
                <path d="M12 5v14" />
            </IconBase>
        );
        const Clipboard = ({ className }) => (
            <IconBase className={className}>
                <rect width="8" height="4" x="8" y="2" rx="1" ry="1" />
                <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2" />
            </IconBase>
        );
        const AlertTriangle = ({ className }) => (
            <IconBase className={className}>
                <path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z" />
                <path d="M12 9v4" />
                <path d="M12 17h.01" />
            </IconBase>
        );
        const Shield = ({ className }) => (
            <IconBase className={className}>
                <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10" />
            </IconBase>
        );
        const RotateCcw = ({ className }) => (
            <IconBase className={className}>
                <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8" />
                <path d="M3 3v5h5" />
            </IconBase>
        );
        const XIcon = ({ className }) => (
            <IconBase className={className}>
                <path d="M18 6 6 18" />
                <path d="m6 6 12 12" />
            </IconBase>
        );
        const Copy = ({ className }) => (
            <IconBase className={className}>
                <rect width="14" height="14" x="8" y="8" rx="2" ry="2" />
                <path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2" />
            </IconBase>
        );
        const Check = ({ className }) => (
            <IconBase className={className}>
                <path d="M20 6 9 17l-5-5" />
            </IconBase>
        );
        const ListChecks = ({ className }) => (
            <IconBase className={className}>
                <path d="M10 6h11" />
                <path d="M10 12h11" />
                <path d="M10 18h11" />
                <path d="M4 6h1" />
                <path d="M4 12h1" />
                <path d="M4 18h1" />
            </IconBase>
        );
        const Square = ({ className }) => (
            <IconBase className={className}>
                <rect width="18" height="18" x="3" y="3" rx="2" />
            </IconBase>
        );
        const SquareCheck = ({ className }) => (
            <IconBase className={className}>
                <rect width="18" height="18" x="3" y="3" rx="2" />
                <path d="m9 12 2 2 4-4" />
            </IconBase>
        );
        const Clock = ({ className }) => (
            <IconBase className={className}>
                <circle cx="12" cy="12" r="10" />
                <polyline points="12 6 12 12 16 14" />
            </IconBase>
        );

        // --- Constants ---
        const TRIAGE_COLORS = {
            none: 'bg-gray-700 text-gray-300',
            green: 'bg-green-600 text-white',
            yellow: 'bg-yellow-500 text-black',
            red: 'bg-red-600 text-white',
            black: 'bg-gray-900 text-gray-400 border border-gray-600'
        };

        const TRIAGE_LABELS = {
            none: '未定',
            green: '緑(軽症)',
            yellow: '黄(中等)',
            red: '赤(重症)',
            black: '黒(死亡)'
        };

        const CHECKLIST_ITEMS = [
            '安全管理', '放水・消火器', '車両固定', '漏油対策',
            '貴重品管理', '現場写真', '車検証', '渋滞情報',
            '減隊・増隊', 'バッテリー', '状況報告１', '状況報告２', '状況報告３'
        ];

        // --- Main Component ---
        const TrafficRescueMemo = () => {
            // --- State Management ---
            const loadInitialData = () => {
                try {
                    const saved = localStorage.getItem('traffic_rescue_data');
                    if (saved) return JSON.parse(saved);
                } catch (e) {
                    console.error("Load failed", e);
                }
                return null;
            };

            const initialData = loadInitialData();

            const [sceneInfo, setSceneInfo] = useState(initialData?.sceneInfo || {
                location: '',
                time: '',
                situation: '車両相互の事故',
            });

            const [vehicles, setVehicles] = useState(initialData?.vehicles || [
                {
                    id: Date.now(),
                    type: '普通車',
                    plate: '',
                    damage: '中破',
                    occupants: []
                }
            ]);

            const [others, setOthers] = useState(initialData?.others || {
                police: '',
                witness: '',
                fireDept: ''
            });

            // Checklist state: Object with timestamps or boolean
            // Format: { "安全管理": "10:15", "車両固定": "10:20" }
            const [checklist, setChecklist] = useState(initialData?.checklist || {});

            const [notification, setNotification] = useState(null);
            
            // Modals State
            const [showReportModal, setShowReportModal] = useState(false);
            const [reportText, setReportText] = useState('');
            
            const [showDeleteModal, setShowDeleteModal] = useState(false);
            const [deleteTarget, setDeleteTarget] = useState(null);

            // --- Auto Save ---
            useEffect(() => {
                const dataToSave = { sceneInfo, vehicles, others, checklist };
                localStorage.setItem('traffic_rescue_data', JSON.stringify(dataToSave));
            }, [sceneInfo, vehicles, others, checklist]);

            // --- Helper Functions ---
            const showNotification = (msg) => {
                setNotification(msg);
                setTimeout(() => setNotification(null), 3000);
            };

            const getCurrentTime = () => {
                const now = new Date();
                return now.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });
            };

            // --- Checklist Logic ---
            const toggleCheckItem = (item) => {
                setChecklist(prev => {
                    const newState = { ...prev };
                    if (newState[item]) {
                        // If already checked, remove it (toggle off)
                        delete newState[item];
                    } else {
                        // If not checked, set current time
                        newState[item] = getCurrentTime();
                    }
                    return newState;
                });
            };

            // --- Deletion Logic ---
            const requestDeleteVehicle = (id) => {
                setDeleteTarget({ type: 'vehicle', vehicleId: id });
                setShowDeleteModal(true);
            };

            const requestDeleteOccupant = (vId, oId) => {
                setDeleteTarget({ type: 'occupant', vehicleId: vId, occupantId: oId });
                setShowDeleteModal(true);
            };

            const requestReset = () => {
                setDeleteTarget({ type: 'reset' });
                setShowDeleteModal(true);
            };

            const confirmDelete = () => {
                if (!deleteTarget) return;

                if (deleteTarget.type === 'vehicle') {
                    setVehicles(prev => prev.filter(v => v.id !== deleteTarget.vehicleId));
                    showNotification('車両を削除しました');
                } else if (deleteTarget.type === 'occupant') {
                    setVehicles(prev => prev.map(v => {
                        if (v.id === deleteTarget.vehicleId) {
                            return { ...v, occupants: v.occupants.filter(o => o.id !== deleteTarget.occupantId) };
                        }
                        return v;
                    }));
                    showNotification('乗員を削除しました');
                } else if (deleteTarget.type === 'reset') {
                    setVehicles([{ id: Date.now(), type: '普通車', plate: '', damage: '中破', occupants: [] }]);
                    setSceneInfo({ location: '', time: '', situation: '車両相互の事故' });
                    setOthers({ police: '', witness: '', fireDept: '' });
                    setChecklist({}); // Reset checklist
                    showNotification('リセット完了');
                }

                setShowDeleteModal(false);
                setDeleteTarget(null);
            };

            // --- Data Handlers ---
            const updateScene = (field, value) => setSceneInfo(prev => ({ ...prev, [field]: value }));
            
            const addVehicle = () => {
                setVehicles(prev => [
                    ...prev,
                    { id: Date.now(), type: '普通車', plate: '', damage: '小破', occupants: [] }
                ]);
            };

            const updateVehicle = (id, field, value) => {
                setVehicles(prev => prev.map(v => v.id === id ? { ...v, [field]: value } : v));
            };

            const addOccupant = (vehicleId) => {
                setVehicles(prev => prev.map(v => {
                    if (v.id === vehicleId) {
                        return {
                            ...v,
                            occupants: [...v.occupants, {
                                id: Date.now(), position: '運転席', ageSex: '', triage: 'none', trapped: false, extricated: false, notes: ''
                            }]
                        };
                    }
                    return v;
                }));
            };

            const updateOccupant = (vehicleId, occupantId, field, value) => {
                setVehicles(prev => prev.map(v => {
                    if (v.id === vehicleId) {
                        return {
                            ...v,
                            occupants: v.occupants.map(o => o.id === occupantId ? { ...o, [field]: value } : o)
                        };
                    }
                    return v;
                }));
            };

            // --- Stats & Report ---
            const stats = vehicles.reduce((acc, v) => {
                acc.totalVehicles += 1;
                acc.totalOccupants += v.occupants.length;
                v.occupants.forEach(o => {
                    if (o.trapped && !o.extricated) acc.trapped += 1;
                    if (o.triage === 'red') acc.red += 1;
                    if (o.triage === 'yellow') acc.yellow += 1;
                    if (o.triage === 'black') acc.black += 1;
                });
                return acc;
            }, { totalVehicles: 0, totalOccupants: 0, trapped: 0, red: 0, yellow: 0, black: 0 });

            const handleGenerateReport = () => {
                let text = `【交通救助メモ】\n`;
                text += `場所: ${sceneInfo.location || '未入力'}\n`;
                text += `概要: ${sceneInfo.situation}\n`;
                text += `集計: 車両${stats.totalVehicles}台 / 傷病者${stats.totalOccupants}名 (残${stats.trapped}名)\n`;
                text += `------------------\n`;

                vehicles.forEach((v, index) => {
                    text += `[車両${index + 1}] ${v.type} (${v.plate || 'No不明'}) - ${v.damage}\n`;
                    if (v.occupants.length === 0) {
                        text += `  └ 乗員情報なし\n`;
                    } else {
                        v.occupants.forEach(o => {
                            const trappedStatus = o.trapped ? (o.extricated ? '【救出済】' : '【★要救助】') : '';
                            const triageText = TRIAGE_LABELS[o.triage];
                            text += `  └ ${o.position}: ${o.ageSex || '年齢不明'} [${triageText}] ${trappedStatus} ${o.notes}\n`;
                        });
                    }
                });
                
                text += `------------------\n`;
                if (others.police) text += `警察: ${others.police}\n`;
                if (others.witness) text += `目撃者: ${others.witness}\n`;
                if (others.fireDept) text += `活動隊: ${others.fireDept}\n`;
                
                // Add Checked Items to Report with Timestamps
                const checkedItems = CHECKLIST_ITEMS.filter(item => !!checklist[item]);
                if (checkedItems.length > 0) {
                    text += `------------------\n`;
                    text += `【活動記録】\n`;
                    checkedItems.forEach(item => {
                        const timeVal = checklist[item];
                        const timeStr = (typeof timeVal === 'string' && timeVal.includes(':')) ? `(${timeVal})` : '';
                        text += `・${item} ${timeStr}\n`;
                    });
                }

                setReportText(text);
                setShowReportModal(true);
            };

            const copyToClipboard = () => {
                try {
                    const textArea = document.createElement("textarea");
                    textArea.value = reportText;
                    textArea.style.position = "fixed";
                    textArea.style.left = "-9999px";
                    textArea.style.top = "0";
                    document.body.appendChild(textArea);
                    textArea.focus();
                    textArea.select();
                    
                    const successful = document.execCommand('copy');
                    document.body.removeChild(textArea);
                    
                    if (successful) {
                        showNotification('コピー完了！');
                        setShowReportModal(false);
                    } else {
                        showNotification('コピーに失敗しました');
                    }
                } catch (err) {
                    console.error('Fallback copy failed', err);
                    showNotification('エラーが発生しました');
                }
            };

            // --- Render ---
            return (
                <div className="min-h-screen bg-slate-900 text-slate-100 pb-32 font-sans relative">
                    {/* Header */}
                    <header className="bg-blue-900 p-4 sticky top-0 z-40 shadow-lg flex justify-between items-center">
                        <h1 className="text-2xl font-bold flex items-center gap-3">
                            <Car className="w-8 h-8 text-yellow-400" />
                            交通救助メモ
                        </h1>
                        <button onClick={requestReset} className="p-3 bg-slate-700 rounded-full hover:bg-slate-600">
                            <RotateCcw className="w-6 h-6 text-gray-300" />
                        </button>
                    </header>

                    {/* Dashboard Stats */}
                    <div className="grid grid-cols-4 gap-2 p-2 bg-slate-800 border-b border-slate-700 sticky top-20 z-30 shadow-md">
                        <div className="bg-slate-700 p-2 rounded text-center">
                            <div className="text-sm text-gray-300 mb-1">車両数</div>
                            <div className="text-3xl font-bold text-white">{stats.totalVehicles}</div>
                        </div>
                        <div className="bg-slate-700 p-2 rounded text-center">
                            <div className="text-sm text-gray-300 mb-1">傷病者</div>
                            <div className="text-3xl font-bold text-white">{stats.totalOccupants}</div>
                        </div>
                        <div className="bg-red-900/60 p-2 rounded text-center border-2 border-red-600">
                            <div className="text-sm text-red-200 font-bold mb-1">要救助</div>
                            <div className="text-3xl font-bold text-white">{stats.trapped}</div>
                        </div>
                        <div className="bg-slate-700 p-1 rounded text-center flex flex-col justify-center items-center">
                            <div className="flex flex-col gap-0 w-full px-1">
                                <div className="text-sm text-red-400 font-bold border-b border-slate-600">赤 {stats.red}</div>
                                <div className="text-sm text-yellow-400 font-bold border-b border-slate-600">黄 {stats.yellow}</div>
                                <div className="text-xs text-gray-400 font-bold">黒 {stats.black}</div>
                            </div>
                        </div>
                    </div>

                    <main className="p-3 space-y-8">
                        {/* Scene Info */}
                        <section className="space-y-4">
                            <div>
                                <label className="text-gray-400 text-sm mb-1 block">事故形態</label>
                                <input 
                                    type="text" 
                                    placeholder="例: 正面衝突" 
                                    className="w-full bg-slate-800 border border-slate-600 rounded p-4 text-lg font-bold text-white focus:border-blue-500 focus:outline-none"
                                    value={sceneInfo.situation}
                                    onChange={(e) => updateScene('situation', e.target.value)}
                                />
                            </div>
                            <div>
                                <label className="text-gray-400 text-sm mb-1 block">場所・目標</label>
                                <input 
                                    type="text" 
                                    placeholder="場所を入力" 
                                    className="w-full bg-slate-800 border border-slate-600 rounded p-4 text-lg font-bold text-white focus:border-blue-500 focus:outline-none"
                                    value={sceneInfo.location}
                                    onChange={(e) => updateScene('location', e.target.value)}
                                />
                            </div>
                        </section>

                        {/* Activity Checklist Section - NEW */}
                        <section className="bg-slate-800 p-4 rounded-xl border border-slate-700">
                            <h2 className="text-lg font-bold text-gray-300 mb-4 flex items-center gap-2 border-b border-slate-600 pb-2">
                                <Clock className="w-6 h-6 text-emerald-400" /> 活動管理 (時刻記録)
                            </h2>
                            <div className="grid grid-cols-2 gap-3">
                                {CHECKLIST_ITEMS.map((item) => {
                                    const checkData = checklist[item];
                                    const isChecked = !!checkData;
                                    const timeString = (typeof checkData === 'string') ? checkData : '';

                                    return (
                                        <button
                                            key={item}
                                            onClick={() => toggleCheckItem(item)}
                                            className={`p-3 rounded-lg border-2 font-bold text-left flex items-center justify-between gap-2 transition-all
                                                ${isChecked 
                                                    ? 'bg-emerald-900/50 border-emerald-500 text-emerald-300 shadow-lg shadow-emerald-900/20' 
                                                    : 'bg-slate-900 border-slate-600 text-gray-400 hover:bg-slate-700'
                                                }`}
                                        >
                                            <div className="flex items-center gap-2 overflow-hidden">
                                                {isChecked ? (
                                                    <SquareCheck className="w-6 h-6 flex-shrink-0 text-emerald-500" />
                                                ) : (
                                                    <Square className="w-6 h-6 flex-shrink-0 text-gray-500" />
                                                )}
                                                <span className="text-sm truncate">{item}</span>
                                            </div>
                                            {isChecked && timeString && (
                                                <span className="text-xs font-mono bg-slate-800 px-2 py-1 rounded text-emerald-400 border border-emerald-500/30 shadow-inner">
                                                    {timeString}
                                                </span>
                                            )}
                                        </button>
                                    );
                                })}
                            </div>
                        </section>

                        {/* Vehicles List */}
                        <div className="space-y-6">
                            {vehicles.map((vehicle, vIndex) => (
                                <div key={vehicle.id} className="bg-slate-800 rounded-xl border border-slate-600 overflow-hidden shadow-lg">
                                    {/* Vehicle Header */}
                                    <div className="bg-slate-700 p-4 flex justify-between items-center border-b border-slate-600">
                                        <div className="flex items-center gap-3 flex-1">
                                            <span className="bg-blue-600 text-white text-lg px-3 py-1 rounded font-bold whitespace-nowrap">車両 {vIndex + 1}</span>
                                            <select 
                                                className="bg-slate-800 border border-slate-500 text-lg font-bold rounded p-2 flex-1 max-w-[180px] h-12"
                                                value={vehicle.type}
                                                onChange={(e) => updateVehicle(vehicle.id, 'type', e.target.value)}
                                            >
                                                <option>普通車</option>
                                                <option>軽乗用</option>
                                                <option>トラック</option>
                                                <option>バス</option>
                                                <option>二輪</option>
                                                <option>歩行者</option>
                                            </select>
                                        </div>
                                        <button onClick={() => requestDeleteVehicle(vehicle.id)} className="text-gray-400 hover:text-red-400 p-3 bg-slate-800 rounded ml-2">
                                            <Trash2 className="w-6 h-6" />
                                        </button>
                                    </div>

                                    <div className="p-4 space-y-4">
                                        <div className="flex gap-3">
                                            <input 
                                                type="text" 
                                                placeholder="No.下4桁" 
                                                className="flex-1 bg-slate-900 border border-slate-600 rounded p-3 text-lg font-bold h-14"
                                                value={vehicle.plate}
                                                onChange={(e) => updateVehicle(vehicle.id, 'plate', e.target.value)}
                                            />
                                            <select 
                                                className="bg-slate-900 border border-slate-600 rounded p-2 text-lg font-bold w-32 h-14"
                                                value={vehicle.damage}
                                                onChange={(e) => updateVehicle(vehicle.id, 'damage', e.target.value)}
                                            >
                                                <option>小破</option>
                                                <option>中破</option>
                                                <option>大破</option>
                                                <option>全焼</option>
                                            </select>
                                        </div>

                                        {/* Occupants List */}
                                        <div className="space-y-4">
                                            {vehicle.occupants.map((occupant) => (
                                                <div key={occupant.id} className="bg-slate-900/50 p-3 rounded-lg border-2 border-slate-700">
                                                    <div className="flex justify-between items-center mb-3">
                                                        <div className="flex gap-3 items-center flex-1">
                                                            <User className="w-6 h-6 text-gray-400" />
                                                            <select 
                                                                className="bg-transparent text-blue-300 text-xl font-bold border-b border-blue-900 py-1 flex-1"
                                                                value={occupant.position}
                                                                onChange={(e) => updateOccupant(vehicle.id, occupant.id, 'position', e.target.value)}
                                                            >
                                                                <option>運転席</option>
                                                                <option>助手席</option>
                                                                <option>後部右</option>
                                                                <option>後部左</option>
                                                                <option>後中/他</option>
                                                                <option>車外放出</option>
                                                            </select>
                                                        </div>
                                                        <button onClick={() => requestDeleteOccupant(vehicle.id, occupant.id)} className="text-gray-500 hover:text-red-500 p-2 bg-slate-800 rounded">
                                                            <Trash2 className="w-6 h-6" />
                                                        </button>
                                                    </div>
                                                    
                                                    <div className="grid grid-cols-12 gap-3 mb-3">
                                                        <input 
                                                            type="text" 
                                                            placeholder="30代男" 
                                                            className="col-span-5 bg-slate-800 border border-slate-600 rounded px-3 py-3 text-lg font-bold text-center"
                                                            value={occupant.ageSex}
                                                            onChange={(e) => updateOccupant(vehicle.id, occupant.id, 'ageSex', e.target.value)}
                                                        />
                                                        <select 
                                                            className={`col-span-7 rounded px-2 py-3 text-lg font-bold border-2 border-slate-500 ${TRIAGE_COLORS[occupant.triage]}`}
                                                            value={occupant.triage}
                                                            onChange={(e) => updateOccupant(vehicle.id, occupant.id, 'triage', e.target.value)}
                                                        >
                                                            {Object.entries(TRIAGE_LABELS).map(([key, label]) => (
                                                                <option key={key} value={key} className="bg-slate-800 text-white">
                                                                    {label}
                                                                </option>
                                                            ))}
                                                        </select>
                                                    </div>

                                                    <div className="flex flex-col gap-3">
                                                        <button 
                                                            onClick={() => {
                                                                if (!occupant.trapped) {
                                                                    updateOccupant(vehicle.id, occupant.id, 'trapped', true);
                                                                } else if (occupant.trapped && !occupant.extricated) {
                                                                    updateOccupant(vehicle.id, occupant.id, 'extricated', true);
                                                                } else {
                                                                    updateOccupant(vehicle.id, occupant.id, 'trapped', false);
                                                                    updateOccupant(vehicle.id, occupant.id, 'extricated', false);
                                                                }
                                                            }}
                                                            className={`w-full py-4 rounded-lg text-lg border-2 flex items-center justify-center gap-3 font-bold transition-colors
                                                                ${!occupant.trapped 
                                                                    ? 'border-slate-600 text-gray-400 bg-slate-800' 
                                                                    : (occupant.extricated 
                                                                        ? 'bg-green-900 border-green-500 text-green-300' 
                                                                        : 'bg-red-900 border-red-500 text-red-100 animate-pulse')
                                                                }`}
                                                        >
                                                            <AlertTriangle className={`w-6 h-6 ${occupant.trapped && !occupant.extricated ? 'animate-bounce' : ''}`} />
                                                            {!occupant.trapped ? '閉じ込め無' : (occupant.extricated ? '【 救出完了 】' : '★ 要救助 ★')}
                                                        </button>
                                                        
                                                        <input 
                                                            type="text" 
                                                            placeholder="メモ (痛い箇所など)" 
                                                            className="w-full bg-slate-800 border border-slate-600 rounded px-3 py-3 text-lg"
                                                            value={occupant.notes}
                                                            onChange={(e) => updateOccupant(vehicle.id, occupant.id, 'notes', e.target.value)}
                                                        />
                                                    </div>
                                                </div>
                                            ))}
                                            
                                            <button 
                                                onClick={() => addOccupant(vehicle.id)}
                                                className="w-full py-4 border-2 border-dashed border-slate-500 rounded-lg text-slate-300 text-lg font-bold hover:bg-slate-700 hover:text-blue-300 flex items-center justify-center gap-3"
                                            >
                                                <Plus className="w-6 h-6" />
                                                乗員を追加
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            ))}

                            <button 
                                onClick={addVehicle}
                                className="w-full bg-blue-800 hover:bg-blue-700 text-white text-xl font-bold py-5 rounded-xl shadow-xl flex items-center justify-center gap-3 border-2 border-blue-400"
                            >
                                <Car className="w-8 h-8" />
                                車両を追加
                            </button>
                        </div>

                        {/* Others / Staff */}
                        <section className="bg-slate-800 p-4 rounded-xl border border-slate-700 mt-8">
                            <h2 className="text-lg font-bold text-gray-300 mb-4 flex items-center gap-2 border-b border-slate-600 pb-2">
                                <Shield className="w-6 h-6" /> 関係者・活動隊
                            </h2>
                            <div className="space-y-4">
                                <div className="flex flex-col gap-1">
                                    <span className="text-sm text-gray-400">警察</span>
                                    <input 
                                        type="text" 
                                        placeholder="所属・氏名"
                                        className="w-full bg-slate-900 border border-slate-600 rounded p-3 text-lg h-12"
                                        value={others.police}
                                        onChange={(e) => setOthers({...others, police: e.target.value})}
                                    />
                                </div>
                                <div className="flex flex-col gap-1">
                                    <span className="text-sm text-gray-400">目撃者</span>
                                    <input 
                                        type="text" 
                                        placeholder="連絡先・氏名"
                                        className="w-full bg-slate-900 border border-slate-600 rounded p-3 text-lg h-12"
                                        value={others.witness}
                                        onChange={(e) => setOthers({...others, witness: e.target.value})}
                                    />
                                </div>
                                <div className="flex flex-col gap-1">
                                    <span className="text-sm text-gray-400">活動隊</span>
                                    <input 
                                        type="text" 
                                        placeholder="隊名"
                                        className="w-full bg-slate-900 border border-slate-600 rounded p-3 text-lg h-12"
                                        value={others.fireDept}
                                        onChange={(e) => setOthers({...others, fireDept: e.target.value})}
                                    />
                                </div>
                            </div>
                        </section>
                    </main>

                    {/* Floating Copy Button */}
                    <div className="fixed bottom-8 right-6 z-40">
                        <button 
                            onClick={handleGenerateReport}
                            className="bg-emerald-600 hover:bg-emerald-500 text-white w-20 h-20 rounded-full shadow-2xl shadow-black flex items-center justify-center border-4 border-emerald-400 transition-transform active:scale-95"
                        >
                            <Clipboard className="w-10 h-10" />
                        </button>
                    </div>

                    {/* Report Modal */}
                    {showReportModal && (
                        <div className="fixed inset-0 bg-black/90 z-50 flex items-center justify-center p-2">
                            <div className="bg-slate-800 w-full h-full md:h-auto md:max-w-lg rounded-xl shadow-2xl border border-slate-700 flex flex-col">
                                <div className="p-4 border-b border-slate-700 flex justify-between items-center bg-slate-900">
                                    <h3 className="text-xl font-bold text-emerald-400 flex items-center gap-2">
                                        <Clipboard className="w-6 h-6" /> 活動レポート
                                    </h3>
                                    <button onClick={() => setShowReportModal(false)} className="p-3 bg-slate-700 rounded-full">
                                        <XIcon className="w-6 h-6" />
                                    </button>
                                </div>
                                <div className="p-4 flex-1 overflow-auto bg-slate-900">
                                    <textarea 
                                        className="w-full h-full min-h-[300px] bg-slate-800 border border-slate-600 rounded p-4 text-lg font-mono text-white leading-relaxed focus:outline-none focus:border-emerald-500"
                                        value={reportText}
                                        onChange={(e) => setReportText(e.target.value)}
                                    />
                                </div>
                                <div className="p-4 border-t border-slate-700 bg-slate-900">
                                    <button 
                                        onClick={copyToClipboard}
                                        className="w-full bg-emerald-600 hover:bg-emerald-500 text-white text-xl font-bold py-4 rounded-xl flex items-center justify-center gap-3 border-2 border-emerald-400"
                                    >
                                        <Copy className="w-6 h-6" />
                                        コピーして閉じる
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Delete Confirmation Modal */}
                    {showDeleteModal && (
                        <div className="fixed inset-0 bg-black/90 z-50 flex items-center justify-center p-4">
                            <div className="bg-slate-800 w-full max-w-sm rounded-xl shadow-2xl border border-slate-700 p-8 text-center">
                                <AlertTriangle className="w-16 h-16 text-red-500 mx-auto mb-6" />
                                <h3 className="text-2xl font-bold text-white mb-4">削除しますか？</h3>
                                <p className="text-gray-300 text-lg mb-8">
                                    {deleteTarget?.type === 'reset' 
                                        ? '入力データが全て消えます。'
                                        : 'この項目を削除します。'
                                    }
                                </p>
                                <div className="flex flex-col gap-4">
                                    <button 
                                        onClick={confirmDelete}
                                        className="w-full py-4 bg-red-600 hover:bg-red-500 rounded-xl text-white text-xl font-bold border-2 border-red-400"
                                    >
                                        削除実行
                                    </button>
                                    <button 
                                        onClick={() => setShowDeleteModal(false)}
                                        className="w-full py-4 bg-slate-700 hover:bg-slate-600 rounded-xl text-gray-300 text-xl font-bold"
                                    >
                                        キャンセル
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Notification Toast */}
                    {notification && (
                        <div className="fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-emerald-600 text-white px-8 py-6 rounded-2xl shadow-2xl text-xl font-bold animate-bounce z-50 flex items-center gap-3 border-2 border-white">
                            <Check className="w-8 h-8" /> {notification}
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<TrafficRescueMemo />);
    </script>
</body>
</html>
