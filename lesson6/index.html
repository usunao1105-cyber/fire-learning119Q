<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EMS MEMO - ParamedicLog</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel (for JSX) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        /* モバイル向けの調整 */
        body {
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }
        /* ちらつき防止 */
        .cloak {
            display: none;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-900">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback } = React;

        // --- Icons (Lucideの簡易実装) ---
        const Icon = ({ size = 24, className = "", children }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                {children}
            </svg>
        );

        const Activity = (props) => <Icon {...props}><polyline points="22 12 18 12 15 21 9 3 6 12 2 12" /></Icon>;
        const Clock = (props) => <Icon {...props}><circle cx="12" cy="12" r="10" /><polyline points="12 6 12 12 16 14" /></Icon>;
        const Send = (props) => <Icon {...props}><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></Icon>;
        const FileText = (props) => <Icon {...props}><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></Icon>;
        const Trash2 = (props) => <Icon {...props}><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></Icon>;
        const Copy = (props) => <Icon {...props}><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></Icon>;
        const Save = (props) => <Icon {...props}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></Icon>;
        const RotateCcw = (props) => <Icon {...props}><polyline points="1 4 1 10 7 10"/><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"/></Icon>;
        const ChevronDown = (props) => <Icon {...props}><polyline points="6 9 12 15 18 9"/></Icon>;
        const ChevronUp = (props) => <Icon {...props}><polyline points="18 15 12 9 6 15"/></Icon>;
        const AlertTriangle = (props) => <Icon {...props}><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></Icon>;
        const StopCircle = (props) => <Icon {...props}><circle cx="12" cy="12" r="10"/><rect x="9" y="9" width="6" height="6"/></Icon>;
        const Play = (props) => <Icon {...props}><polygon points="5 3 19 12 5 21 5 3"/></Icon>;
        const Hash = (props) => <Icon {...props}><line x1="4" y1="9" x2="20" y2="9"/><line x1="4" y1="15" x2="20" y2="15"/><line x1="10" y1="3" x2="8" y2="21"/><line x1="16" y1="3" x2="14" y2="21"/></Icon>;
        const Flag = (props) => <Icon {...props}><path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z"/><line x1="4" y1="22" x2="4" y2="15"/></Icon>;

        // --- Helper Functions ---
        const formatTime = (date) => {
            return date.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
        };

        const formatElapsed = (seconds) => {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        };

        // --- Constants ---
        const QUICK_ACTIONS = [
            { label: '現着', type: 'milestone' },
            { label: '接触', type: 'milestone' },
            { label: '車内収容', type: 'milestone' },
            { label: '病院着', type: 'milestone' },
            { label: '心電図', type: 'treatment' }, // 赤色 (treatment)
            { label: '酸素投与', type: 'treatment' },
            { label: 'CPR開始', type: 'treatment' },
            { label: '除細動', type: 'treatment' },
            { label: '静脈路確保', type: 'treatment' },
            { label: 'アドレナリン', type: 'treatment' },
            { label: 'バイタル測定', type: 'vitals' },
            { label: 'ROSC', type: 'vitals' }, // 緑色 (vitals)
            { label: '指示要請', type: 'vitals' }, // 緑色 (vitals)
        ];

        // --- Main Component ---
        function App() {
            // --- State ---
            const [logs, setLogs] = useState([]);
            const [inputText, setInputText] = useState('');
            const [startTime, setStartTime] = useState(null);
            const [endTime, setEndTime] = useState(null);
            const [elapsed, setElapsed] = useState(0);
            const [showExport, setShowExport] = useState(false);
            const [showResetConfirm, setShowResetConfirm] = useState(false);
            const [quickActionsOpen, setQuickActionsOpen] = useState(true);
            const [incidentNumber, setIncidentNumber] = useState('');
            const [periodCount, setPeriodCount] = useState(1);
            
            // Refs
            const logsEndRef = useRef(null);

            // --- Timer Logic ---
            useEffect(() => {
                let interval;
                if (startTime && !endTime) {
                interval = setInterval(() => {
                    const now = new Date();
                    const diff = Math.floor((now.getTime() - startTime.getTime()) / 1000);
                    setElapsed(diff);
                }, 1000);
                }
                return () => clearInterval(interval);
            }, [startTime, endTime]);

            // Auto-scroll
            useEffect(() => {
                logsEndRef.current?.scrollIntoView({ behavior: 'smooth' });
            }, [logs]);

            // --- Actions ---
            const handleStartActivity = () => {
                if (!startTime) {
                const now = new Date();
                setStartTime(now);
                setEndTime(null);
                addLog('活動開始 / タイム計測スタート', 'milestone', now, 0);
                }
            };

            const handleEndActivity = () => {
                const now = new Date();
                setEndTime(now);
                addLog('活動終了 / タイム計測ストップ', 'milestone', now);
                setShowExport(true);
            };

            const handlePeriod = () => {
                const now = new Date();
                addLog(`--- 第 ${periodCount} ピリオド ---`, 'milestone', now);
                setPeriodCount(prev => prev + 1);
            };

            const handleResumeActivity = () => {
                const now = new Date();
                setEndTime(null);
                addLog('活動再開', 'milestone', now);
            };

            const handleResetClick = () => {
                setShowResetConfirm(true);
            };

            const executeReset = () => {
                setLogs([]);
                setStartTime(null);
                setEndTime(null);
                setElapsed(0);
                setInputText('');
                setIncidentNumber('');
                setPeriodCount(1);
                setShowExport(false);
                setShowResetConfirm(false);
            };

            const addLog = (content, type = 'note', customTime, customElapsed) => {
                const now = customTime || new Date();
                let currentElapsed = 0;
                
                if (startTime) {
                currentElapsed = Math.floor((now.getTime() - startTime.getTime()) / 1000);
                } else if (!startTime && !customTime) {
                    setStartTime(now);
                    currentElapsed = 0;
                } else if (customElapsed !== undefined) {
                    currentElapsed = customElapsed;
                }

                const newLog = {
                id: Math.random().toString(36).substr(2, 9),
                timestamp: now,
                elapsedSeconds: currentElapsed,
                content,
                type,
                };
                setLogs((prev) => [...prev, newLog]);
            };

            const handleManualSubmit = (e) => {
                e?.preventDefault();
                if (!inputText.trim()) return;
                addLog(inputText, 'note');
                setInputText('');
            };

            const copyToClipboard = () => {
                const header = incidentNumber ? `--- 事案番号: ${incidentNumber} ---\n` : '';
                
                const logText = logs.map(log => {
                const timeStr = formatTime(log.timestamp);
                const elapsedStr = formatElapsed(log.elapsedSeconds);
                return `[${timeStr}] (+${elapsedStr}) ${log.type === 'treatment' ? '【処置】' : ''} ${log.content}`;
                }).join('\n');
                
                const textToCopy = header + `\n--- 活動ログ ---\n` + logText;

                if (navigator.clipboard && navigator.clipboard.writeText) {
                    navigator.clipboard.writeText(textToCopy)
                        .then(() => alert('クリップボードにコピーしました'))
                        .catch(err => {
                            fallbackCopy(textToCopy);
                        });
                } else {
                    fallbackCopy(textToCopy);
                }
            };

            const fallbackCopy = (text) => {
                const textArea = document.createElement("textarea");
                textArea.value = text;
                textArea.style.position = "fixed";
                textArea.style.left = "-9999px";
                textArea.style.top = "0";
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                try {
                    const successful = document.execCommand('copy');
                    if (successful) {
                        alert('クリップボードにコピーしました');
                    } else {
                        alert('コピーに失敗しました');
                    }
                } catch (err) {
                    console.error('Fallback: Oops, unable to copy', err);
                    alert('コピーに失敗しました');
                }
                document.body.removeChild(textArea);
            }

            const getLogColor = (type) => {
                switch (type) {
                case 'treatment': return 'bg-red-50 border-l-4 border-red-500 text-red-900';
                case 'milestone': return 'bg-blue-50 border-l-4 border-blue-500 text-blue-900 font-bold';
                case 'vitals': return 'bg-green-50 border-l-4 border-green-500 text-green-900';
                default: return 'bg-white border-l-4 border-gray-300 text-gray-800';
                }
            };

            return (
                <div className="flex flex-col h-screen bg-gray-100 font-sans max-w-md mx-auto shadow-2xl overflow-hidden relative">
                
                {/* --- Header: Timer Area --- */}
                <div className="bg-slate-900 text-white p-4 shadow-md z-10">
                    <div className="flex justify-between items-center mb-2">
                    <div className="flex items-center gap-2">
                        <Activity className="text-red-500 animate-pulse" size={20} />
                        <h1 className="font-bold text-lg tracking-wider">EMS MEMO</h1>
                    </div>
                    <div className="text-xs text-gray-400">
                        {endTime ? `End: ${formatTime(endTime)}` : formatTime(new Date())}
                    </div>
                    </div>
                    
                    {/* --- Incident Number --- */}
                    <div className="flex items-center justify-between gap-3 mb-3">
                        <div className="flex items-center bg-slate-800 rounded-lg p-2 flex-1">
                            <Hash size={18} className="text-blue-400 mr-2" />
                            <input
                                type="text"
                                placeholder="事案番号を入力"
                                value={incidentNumber}
                                onChange={(e) => setIncidentNumber(e.target.value)}
                                className="flex-1 bg-transparent text-white placeholder-gray-500 border-0 p-0 text-sm focus:ring-0 outline-none font-mono"
                            />
                        </div>
                    </div>
                    
                    <div className="flex items-end justify-between gap-4">
                    <div>
                        <p className="text-xs text-gray-400 uppercase mb-1">Elapsed Time</p>
                        <div className={`text-4xl font-mono font-bold tracking-tighter tabular-nums ${endTime ? 'text-yellow-400' : 'text-white'}`}>
                        {formatElapsed(elapsed)}
                        </div>
                    </div>
                    
                    <div className="flex flex-col gap-2 items-end flex-1">
                        {!startTime ? (
                        <button 
                            onClick={handleStartActivity}
                            className="bg-green-600 hover:bg-green-500 text-white px-4 py-3 rounded shadow-lg font-bold text-sm flex items-center gap-2 transition-transform active:scale-95"
                        >
                            <Clock size={16} />
                            計測開始
                        </button>
                        ) : !endTime ? (
                        <>
                            <button 
                                onClick={handlePeriod}
                                className="bg-green-600 hover:bg-green-500 text-white px-4 py-3 rounded shadow-lg font-bold text-sm flex items-center gap-2 transition-transform active:scale-95 w-full justify-center"
                            >
                                <Flag size={16} />
                                ピリオド {periodCount}
                            </button>
                            <button 
                                onClick={handleEndActivity}
                                className="bg-red-600 hover:bg-red-500 text-white px-4 py-3 rounded shadow-lg font-bold text-sm flex items-center gap-2 transition-transform active:scale-95 w-full justify-center"
                            >
                                <StopCircle size={16} />
                                活動終了
                            </button>
                        </>
                        ) : (
                        <div className="flex flex-col gap-2 w-full min-w-[100px]">
                            <button 
                            onClick={handleResetClick}
                            className="bg-gray-700 hover:bg-gray-600 text-gray-300 px-3 py-2 rounded text-xs flex items-center gap-1 justify-center w-full"
                            >
                            <RotateCcw size={12} />
                            リセット
                            </button>
                            <button 
                            onClick={handleResumeActivity}
                            className="bg-blue-900 hover:bg-blue-800 text-blue-200 px-3 py-2 rounded text-xs flex items-center gap-1 justify-center w-full"
                            >
                            <Play size={10} />
                            再開
                            </button>
                        </div>
                        )}
                    </div>
                    </div>
                </div>

                {/* --- Logs Area --- */}
                <div className="flex-1 overflow-y-auto p-4 space-y-3 bg-gray-100 pb-24">
                    {logs.length === 0 && (
                    <div className="text-center text-gray-400 mt-10 flex flex-col items-center">
                        <FileText size={48} className="mb-2 opacity-20" />
                        <p>活動ログがここに表示されます</p>
                        <p className="text-xs mt-2">下のボタンまたは入力で記録</p>
                    </div>
                    )}
                    
                    {logs.map((log) => (
                    <div key={log.id} className={`p-3 rounded shadow-sm flex flex-col gap-1 ${getLogColor(log.type)}`}>
                        <div className="flex justify-between items-start">
                        <span className="text-sm font-medium">{log.content}</span>
                        <button 
                            onClick={() => setLogs(logs.filter(l => l.id !== log.id))}
                            className="text-gray-400 hover:text-red-500 ml-2"
                        >
                            <Trash2 size={14} />
                        </button>
                        </div>
                        <div className="flex justify-between items-center mt-1 text-[10px] opacity-70 font-mono">
                            <span>Time: {formatTime(log.timestamp)}</span>
                            <span>+{formatElapsed(log.elapsedSeconds)}</span>
                        </div>
                    </div>
                    ))}
                    <div ref={logsEndRef} />
                </div>

                {/* --- Quick Actions Panel --- */}
                <div className={`bg-white border-t border-gray-200 transition-all duration-300 ease-in-out ${quickActionsOpen ? 'h-auto' : 'h-10 overflow-hidden'}`}>
                    <div 
                        className="bg-gray-50 p-2 flex justify-center cursor-pointer hover:bg-gray-100"
                        onClick={() => setQuickActionsOpen(!quickActionsOpen)}
                    >
                        {quickActionsOpen ? <ChevronDown size={16} className="text-gray-500"/> : <ChevronUp size={16} className="text-gray-500"/>}
                    </div>
                    
                    {/* Expanded max-height to show more buttons */}
                    <div className="p-2 grid grid-cols-3 gap-2 overflow-y-auto max-h-60 bg-gray-50">
                        {QUICK_ACTIONS.map((action) => (
                        <button
                            key={action.label}
                            onClick={() => addLog(action.label, action.type)}
                            disabled={!!endTime}
                            className={`
                            py-2 px-1 rounded text-xs font-bold shadow-sm border transition-colors active:scale-95
                            ${action.type === 'treatment' ? 'bg-red-100 border-red-200 text-red-800 hover:bg-red-200' : 
                                action.type === 'milestone' ? 'bg-blue-100 border-blue-200 text-blue-800 hover:bg-blue-200' : 
                                'bg-green-100 border-green-200 text-green-800 hover:bg-green-200'}
                            ${!!endTime ? 'opacity-50' : ''} 
                            `}
                        >
                            {action.label}
                        </button>
                        ))}
                    </div>
                </div>

                {/* --- Input Area --- */}
                <div className="bg-white p-3 border-t border-gray-200 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)] z-20">
                    <form onSubmit={handleManualSubmit} className="flex items-center gap-2 mb-2">
                    <input
                        type="text"
                        value={inputText}
                        onChange={(e) => setInputText(e.target.value)}
                        placeholder={endTime ? "事後記録..." : "メモを入力..."}
                        className="flex-1 bg-gray-100 border-0 rounded-full px-4 py-3 text-sm focus:ring-2 focus:ring-blue-500 outline-none"
                    />
                    <button 
                        type="submit"
                        disabled={!inputText.trim()}
                        className="p-3 bg-blue-600 text-white rounded-full shadow-md disabled:bg-gray-300 disabled:cursor-not-allowed"
                    >
                        <Send size={20} />
                    </button>
                    </form>

                    <div className="flex justify-between items-center px-1">
                    <button 
                        type="button" 
                        onClick={() => setShowExport(true)}
                        className="text-xs text-gray-500 flex items-center gap-1 hover:text-blue-600"
                    >
                        <FileText size={14} />
                        ログ書き出し
                    </button>
                    </div>
                </div>

                {/* --- Export Modal --- */}
                {showExport && (
                    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                    <div className="bg-white rounded-lg shadow-xl w-full max-w-sm overflow-hidden animate-in fade-in zoom-in duration-200">
                        <div className="p-4 border-b bg-gray-50 flex justify-between items-center">
                        <h2 className="font-bold text-gray-700 flex items-center gap-2">
                            <Save size={18} />
                            活動記録出力
                        </h2>
                        <button onClick={() => setShowExport(false)} className="text-gray-400 hover:text-gray-600">✕</button>
                        </div>
                        <div className="p-4">
                        <textarea
                            readOnly
                            className="w-full h-48 bg-gray-50 border rounded p-2 text-xs font-mono leading-relaxed mb-4"
                            value={(incidentNumber ? `事案番号: ${incidentNumber}\n---\n` : '') + 
                                `\n--- 活動ログ ---\n` + 
                                logs.map(log => `[${formatTime(log.timestamp)}] (+${formatElapsed(log.elapsedSeconds)}) ${log.type === 'treatment' ? '【処置】' : ''} ${log.content}`).join('\n')}
                        />
                        <div className="flex gap-2">
                            <button 
                            onClick={copyToClipboard}
                            className="flex-1 bg-blue-600 text-white py-2 rounded flex justify-center items-center gap-2 hover:bg-blue-700"
                            >
                            <Copy size={16} />
                            コピー
                            </button>
                            <button 
                            onClick={() => setShowExport(false)}
                            className="flex-1 bg-gray-200 text-gray-700 py-2 rounded hover:bg-gray-300"
                            >
                            閉じる
                            </button>
                        </div>
                        </div>
                    </div>
                    </div>
                )}

                {/* --- Reset Confirmation Modal --- */}
                {showResetConfirm && (
                    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                    <div className="bg-white rounded-lg shadow-xl w-full max-w-xs overflow-hidden p-6 animate-in fade-in zoom-in duration-200">
                        <div className="flex items-center gap-3 mb-4 text-red-600">
                            <AlertTriangle size={24} />
                            <h3 className="text-lg font-bold text-gray-900">新規活動の開始</h3>
                        </div>
                        <p className="text-sm text-gray-600 mb-6 leading-relaxed">
                        現在の記録をすべて消去して、新しい活動を開始しますか？<br/>
                        <span className="text-red-500 text-xs font-bold block mt-2">※必要な場合は先に「ログ書き出し」を行ってください。</span>
                        </p>
                        <div className="flex gap-3">
                        <button
                            onClick={executeReset}
                            className="flex-1 bg-red-600 text-white py-2 rounded hover:bg-red-700 font-bold shadow-sm transition-colors"
                        >
                            リセット
                        </button>
                        <button
                            onClick={() => setShowResetConfirm(false)}
                            className="flex-1 bg-gray-100 text-gray-700 py-2 rounded hover:bg-gray-200 font-medium transition-colors"
                        >
                            キャンセル
                        </button>
                        </div>
                    </div>
                    </div>
                )}

                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
