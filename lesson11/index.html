<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>救急車内分娩支援アプリ</title>
    
    <!-- Tailwind CSS (スタイリング) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM (UIライブラリ) -->
    <script src="https://unpkg.com/react@18.2.0/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
    
    <!-- Babel (ブラウザでJSXを変換) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        /* iOSなどでのタップ時のハイライトを無効化 */
        * {
            -webkit-tap-highlight-color: transparent;
        }
        /* セーフエリア対応（iPhone X以降） */
        .safe-area-bottom {
            padding-bottom: env(safe-area-inset-bottom);
        }
    </style>
</head>
<body class="bg-slate-50 touch-manipulation">
    <div id="root"></div>

    <script type="text/babel">
        // Reactフックの取得
        const { useState, useEffect } = React;

        // --- Icons (SVG Components) ---
        // 外部ライブラリ依存を排除するため、必要なアイコンを内部定義します。

        const IconBase = ({ children, size = 24, className = "" }) => (
            <svg 
                xmlns="http://www.w3.org/2000/svg" 
                width={size} 
                height={size} 
                viewBox="0 0 24 24" 
                fill="none" 
                stroke="currentColor" 
                strokeWidth="2" 
                strokeLinecap="round" 
                strokeLinejoin="round" 
                className={className}
            >
                {children}
            </svg>
        );

        const Siren = (props) => (
            <IconBase {...props}>
                <path d="M7 12a5 5 0 0 1 5-5v0a5 5 0 0 1 5 5v6H7v-6Z" />
                <path d="M5 20a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2v2H5v-2Z" />
                <path d="M21 12h1" />
                <path d="M18.5 4.5 18 5" />
                <path d="M2 12h1" />
                <path d="M12 2v1" />
            </IconBase>
        );

        const ShieldAlert = (props) => (
            <IconBase {...props}>
                <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10" />
                <path d="M12 8v4" />
                <path d="M12 16h.01" />
            </IconBase>
        );

        const Phone = (props) => (
            <IconBase {...props}>
                <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z" />
            </IconBase>
        );

        const CheckSquare = (props) => (
            <IconBase {...props}>
                <path d="m9 11 3 3L22 4" />
                <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11" />
            </IconBase>
        );

        const Play = (props) => (
            <IconBase {...props}>
                <polygon points="5 3 19 12 5 21 5 3" />
            </IconBase>
        );

        const Baby = (props) => (
            <IconBase {...props}>
                <path d="M9 12h.01" />
                <path d="M15 12h.01" />
                <path d="M10 16c.5.3 1.2.5 2 .5s1.5-.2 2-.5" />
                <path d="M19 6.3a9 9 0 0 1 1.8 3.9 2 2 0 0 1 0 3.6 9 9 0 0 1-17.6 0 2 2 0 0 1 0-3.6A9 9 0 0 1 12 3c2 0 3.5 1.1 3.5 2.5s-.9 2.5-2 2.5c-.8 0-1.5-.4-1.5-1" />
            </IconBase>
        );

        const Activity = (props) => (
            <IconBase {...props}>
                <path d="M22 12h-4l-3 9L9 3l-3 9H2" />
            </IconBase>
        );

        const RotateCcw = (props) => (
            <IconBase {...props}>
                <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8" />
                <path d="M3 3v5h5" />
            </IconBase>
        );

        const HeartIcon = (props) => (
            <IconBase {...props}>
                <path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z" />
            </IconBase>
        );

        const Save = (props) => (
            <IconBase {...props}>
                <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z" />
                <polyline points="17 21 17 13 7 13 7 21" />
                <polyline points="7 3 7 8 15 8" />
            </IconBase>
        );

        // --- Helper Functions ---
        const formatTime = (seconds) => {
            const m = Math.floor(seconds / 60);
            const s = seconds % 60;
            return `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
        };

        // --- Sub Components ---

        const ResetConfirmModal = ({ isOpen, onConfirm, onCancel }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-black/60 flex items-center justify-center z-[100] backdrop-blur-sm p-4">
                <div className="bg-white rounded-xl shadow-2xl w-full max-w-sm overflow-hidden animate-in fade-in zoom-in duration-200">
                    <div className="bg-red-600 p-4 text-white flex items-center gap-2">
                    <RotateCcw size={24} />
                    <h3 className="text-lg font-bold">活動終了・リセット</h3>
                    </div>
                    <div className="p-6">
                    <p className="text-slate-700 font-medium mb-2">
                        すべての記録とタイマーをリセットしますか？
                    </p>
                    <p className="text-slate-500 text-sm mb-6">
                        この操作は取り消せません。活動記録が必要な場合は、リセット前に書き写してください。
                    </p>
                    <div className="flex gap-3">
                        <button 
                        onClick={onCancel}
                        className="flex-1 py-3 bg-slate-100 text-slate-700 rounded-lg font-bold hover:bg-slate-200 transition-colors"
                        >
                        キャンセル
                        </button>
                        <button 
                        onClick={onConfirm}
                        className="flex-1 py-3 bg-red-600 text-white rounded-lg font-bold hover:bg-red-700 shadow-md transition-colors"
                        >
                        リセット実行
                        </button>
                    </div>
                    </div>
                </div>
                </div>
            );
        };

        const Header = ({ currentTime, onResetClick }) => (
            <div className="bg-slate-900 text-white p-3 shadow-md flex justify-between items-center sticky top-0 z-50">
                <div className="flex items-center gap-2">
                    <Siren className="text-red-500 animate-pulse" />
                    <h1 className="font-bold text-lg hidden sm:block">救急車内分娩支援</h1>
                    <h1 className="font-bold text-lg sm:hidden">分娩支援</h1>
                </div>
                <div className="flex items-center gap-2">
                    <div className="font-mono text-xl font-bold bg-slate-800 px-3 py-1 rounded">
                        {currentTime.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' })}
                    </div>
                    <button 
                        onClick={onResetClick}
                        className="bg-slate-700 p-2 rounded hover:bg-slate-600 text-slate-300 hover:text-white transition-colors border border-slate-600"
                        aria-label="リセット"
                    >
                        <RotateCcw size={20} />
                    </button>
                </div>
            </div>
        );

        const TabButton = ({ id, label, icon: Icon, colorClass, activeTab, setActiveTab }) => (
            <button
                onClick={() => setActiveTab(id)}
                className={`flex-1 flex flex-col items-center justify-center p-2 text-xs sm:text-sm font-bold transition-all
                ${activeTab === id 
                    ? `${colorClass} text-white shadow-inner` 
                    : 'bg-slate-100 text-slate-500 hover:bg-slate-200'}`}
            >
                {Icon && <Icon size={20} className="mb-1" />}
                {label}
            </button>
        );

        const StopAlert = ({ isStopped, setIsStopped, addLog }) => (
            !isStopped && (
                <div className="bg-red-600 text-white p-4 m-2 rounded-lg shadow-lg flex items-center justify-between animate-bounce-subtle">
                <div className="flex items-center gap-3">
                    <ShieldAlert size={32} />
                    <div>
                    <h2 className="font-bold text-lg">緊急停車・プライバシー確保</h2>
                    <p className="text-sm">安全な場所に停車し、カーテン等で遮蔽してください。</p>
                    </div>
                </div>
                <button 
                    onClick={() => { setIsStopped(true); addLog('救急車停車・現場確保'); }}
                    className="bg-white text-red-600 px-4 py-2 rounded-full font-bold shadow hover:bg-red-50"
                >
                    完了確認
                </button>
                </div>
            )
        );

        const PrepView = ({ setActiveTab, addLog, checkedItems, handleCheck }) => {
            const checkListItems = [
                '車内暖房 (新生児低体温防止)',
                '分娩セット展開 (臍帯クリップ、ガーゼ)',
                '吸引器・酸素の準備',
                '清潔なタオルの確保 (保温用)',
                '母体のプライバシー保護 (カーテン)'
            ];

            return (
                <div className="p-4 space-y-4">
                <div className="bg-orange-50 border-l-4 border-orange-500 p-4 rounded">
                    <h3 className="font-bold text-orange-800 flex items-center gap-2 mb-2">
                    <Phone size={18} /> 受け入れ病院連絡事項
                    </h3>
                    <ul className="list-disc list-inside text-sm text-orange-900 space-y-1">
                    <li>「車内分娩の可能性が高い/進行中」と伝える</li>
                    <li>現在地と到着予想時刻の更新</li>
                    <li>母体情報（週数、経産婦かどうか、破水の有無）</li>
                    </ul>
                </div>

                <div className="bg-white p-4 rounded shadow">
                    <h3 className="font-bold text-slate-700 mb-3 flex items-center gap-2">
                    <CheckSquare size={18} /> 物品・環境準備チェック
                    </h3>
                    <div className="grid grid-cols-1 gap-2">
                    {checkListItems.map((item, idx) => (
                        <label 
                        key={idx} 
                        className={`flex items-center p-3 rounded border transition-colors cursor-pointer select-none
                            ${checkedItems[item] ? 'bg-blue-100 border-blue-400' : 'bg-slate-50 border-slate-200 active:bg-slate-100'}`}
                        >
                        <input 
                            type="checkbox" 
                            className="w-5 h-5 text-blue-600 rounded focus:ring-blue-500 mr-3"
                            checked={!!checkedItems[item]}
                            onChange={() => handleCheck(item)}
                        />
                        <span className={`font-medium ${checkedItems[item] ? 'text-blue-900 font-bold' : 'text-slate-700'}`}>
                            {item}
                        </span>
                        </label>
                    ))}
                    </div>
                </div>
                
                <button 
                    onClick={() => { setActiveTab('delivery'); addLog('分娩介助モードへ移行'); }}
                    className="w-full bg-blue-600 text-white py-4 rounded-lg font-bold text-lg shadow-lg flex items-center justify-center gap-2"
                >
                    分娩進行・介助へ <Play size={20} fill="currentColor" />
                </button>
                </div>
            );
        };

        const DeliveryView = ({ addLog, birthTime, handleBirth, elapsedTime }) => (
            <div className="p-4 space-y-4">
                <div className="grid grid-cols-2 gap-3 mb-4">
                <button onClick={() => addLog('発露確認 (頭が見えた)')} className="p-4 bg-purple-100 text-purple-800 rounded-lg font-bold text-center hover:bg-purple-200 shadow">
                    発露確認
                </button>
                <button onClick={() => addLog('破水確認')} className="p-4 bg-blue-100 text-blue-800 rounded-lg font-bold text-center hover:bg-blue-200 shadow">
                    破水
                </button>
                </div>

                <div className="bg-red-50 border-2 border-red-200 p-4 rounded-xl text-center space-y-4">
                <h3 className="text-xl font-bold text-red-700">児娩出（誕生）</h3>
                <p className="text-sm text-red-600">※全身が出たらすぐにボタンを押してください</p>
                
                {birthTime ? (
                    <div className="bg-red-100 p-4 rounded-lg">
                    <p className="text-slate-600 text-sm">娩出時刻</p>
                    <p className="text-3xl font-mono font-bold text-red-600">
                        {birthTime.toLocaleTimeString('ja-JP')}
                    </p>
                    <p className="text-sm mt-2 font-bold text-red-800">タイマー稼働中: {formatTime(elapsedTime)}</p>
                    </div>
                ) : (
                    <button 
                    onClick={handleBirth}
                    className="w-full bg-red-600 text-white py-6 rounded-xl font-bold text-2xl shadow-xl animate-pulse hover:bg-red-700 active:scale-95 transition-transform"
                    >
                    児 娩出！ (START)
                    </button>
                )}
                </div>

                <div className="bg-white p-4 rounded shadow space-y-2">
                <h4 className="font-bold text-slate-700">介助の要点</h4>
                <ul className="list-decimal list-inside text-sm space-y-1 text-slate-600">
                    <li><strong>会陰保護:</strong> 肛門保護と児頭のコントロール</li>
                    <li><strong>臍帯巻絡確認:</strong> 首にへその緒がないか？あれば緩める</li>
                    <li><strong>気道確保:</strong> 口→鼻の順で拭う・吸引</li>
                    <li><strong>保温:</strong> すぐに乾燥させ、温かいタオルで包む</li>
                </ul>
                </div>
            </div>
        );

        const ApgarScorer = ({ type, data, onChange, onSave }) => {
            const items = [
                { id: 'skin', label: '皮膚色 (A)', options: [{ val: 0, text: '青白' }, { val: 1, text: '手足青' }, { val: 2, text: '全身桃' }] },
                { id: 'pulse', label: '心拍数 (P)', options: [{ val: 0, text: 'なし' }, { val: 1, text: '<100' }, { val: 2, text: '>100' }] },
                { id: 'grimace', label: '刺激反応 (G)', options: [{ val: 0, text: 'なし' }, { val: 1, text: '顔しかめ' }, { val: 2, text: '啼泣' }] },
                { id: 'activity', label: '筋緊張 (A)', options: [{ val: 0, text: 'だらり' }, { val: 1, text: 'やや屈曲' }, { val: 2, text: '活発' }] },
                { id: 'respiration', label: '呼吸 (R)', options: [{ val: 0, text: 'なし' }, { val: 1, text: '遅・不整' }, { val: 2, text: '強い啼泣' }] },
            ];

            const totalScore = Object.values(data).reduce((sum, val) => sum + (val || 0), 0);
            const isComplete = Object.values(data).every(v => v !== null);

            return (
                <div className="space-y-3">
                    <div className="bg-slate-50 p-2 rounded border border-slate-200">
                        {items.map((item) => (
                            <div key={item.id} className="mb-2 last:mb-0">
                                <div className="text-xs font-bold text-slate-600 mb-1">{item.label}</div>
                                <div className="flex gap-1">
                                    {item.options.map((opt) => (
                                        <button
                                            key={opt.val}
                                            onClick={() => onChange(type, item.id, opt.val)}
                                            className={`flex-1 py-2 text-xs rounded border transition-colors
                                                ${data[item.id] === opt.val 
                                                    ? 'bg-blue-600 text-white border-blue-600 font-bold shadow-sm' 
                                                    : 'bg-white text-slate-600 border-slate-300 hover:bg-slate-50'}`}
                                        >
                                            <span className="block text-lg font-bold">{opt.val}</span>
                                            <span className="text-[10px]">{opt.text}</span>
                                        </button>
                                    ))}
                                </div>
                            </div>
                        ))}
                    </div>
                    
                    <div className="flex items-center justify-between bg-slate-100 p-3 rounded">
                        <div>
                            <span className="text-sm font-bold text-slate-600">合計点:</span>
                            <span className={`ml-2 text-2xl font-bold ${totalScore <= 3 ? 'text-red-600' : totalScore <= 6 ? 'text-yellow-600' : 'text-green-600'}`}>
                                {totalScore}点
                            </span>
                        </div>
                        <button
                            onClick={() => onSave(type, totalScore)}
                            className={`flex items-center gap-1 px-4 py-2 rounded font-bold shadow-sm transition-transform active:scale-95
                                ${isComplete ? 'bg-blue-600 text-white hover:bg-blue-700' : 'bg-slate-300 text-slate-500'}`}
                        >
                            <Save size={16} /> 記録
                        </button>
                    </div>
                </div>
            );
        };

        const BabyView = ({ elapsedTime, addLog, apgarData, setApgarData }) => {
            const [apgarTab, setApgarTab] = useState('1'); // '1' or '5'

            const handleApgarChange = (type, field, value) => {
                setApgarData(prev => ({
                    ...prev,
                    [type]: { ...prev[type], [field]: value }
                }));
            };

            const handleApgarSave = (type, score) => {
                const d = apgarData[type];
                // 詳細なログを作成
                const details = `(P${d.skin ?? '-'}, P${d.pulse ?? '-'}, G${d.grimace ?? '-'}, A${d.activity ?? '-'}, R${d.respiration ?? '-'})`;
                addLog(`APGAR(${type}分値): ${score}点 ${details}`);
            };

            return (
                <div className="p-4 space-y-4">
                    {/* Timer Bar */}
                    <div className="bg-slate-800 text-white p-4 rounded-lg shadow flex justify-between items-center">
                    <div>
                        <p className="text-xs text-slate-300">娩出後の経過時間</p>
                        <p className="text-3xl font-mono font-bold">{formatTime(elapsedTime)}</p>
                    </div>
                    <div className="text-right">
                        <div className={`text-sm font-bold px-2 py-1 rounded ${elapsedTime >= 60 && elapsedTime < 300 ? 'bg-yellow-500 text-black' : elapsedTime >= 300 ? 'bg-red-500' : 'bg-slate-600'}`}>
                        APGAR 1分: {elapsedTime >= 60 ? '評価' : '待機'}
                        </div>
                        <div className={`text-sm font-bold px-2 py-1 rounded mt-1 ${elapsedTime >= 300 ? 'bg-yellow-500 text-black' : 'bg-slate-600'}`}>
                        APGAR 5分: {elapsedTime >= 300 ? '評価' : '待機'}
                        </div>
                    </div>
                    </div>

                    {/* Resuscitation Check */}
                    <div className="bg-white p-4 rounded shadow border-l-4 border-blue-500">
                    <h3 className="font-bold text-lg mb-2 flex items-center gap-2">
                        <Activity size={20} className="text-blue-600"/> 初期処置 (NCPR)
                    </h3>
                    <div className="space-y-3">
                        <div className="flex gap-2">
                        <button onClick={() => addLog('児：乾燥・刺激')} className="flex-1 bg-blue-50 py-3 rounded border border-blue-200 font-bold text-blue-800 active:bg-blue-100">
                            乾燥・刺激
                        </button>
                        <button onClick={() => addLog('児：吸引実施')} className="flex-1 bg-blue-50 py-3 rounded border border-blue-200 font-bold text-blue-800 active:bg-blue-100">
                            気道吸引
                        </button>
                        </div>
                        
                        <div className="bg-red-50 p-3 rounded">
                        <p className="font-bold text-red-700 mb-2">呼吸・心拍チェック</p>
                        <div className="grid grid-cols-2 gap-2">
                            <button onClick={() => addLog('児：啼泣あり・良好')} className="bg-green-500 text-white p-2 rounded font-bold shadow">
                            泣いている (良)
                            </button>
                            <button onClick={() => addLog('児：呼吸弱い/なし')} className="bg-red-500 text-white p-2 rounded font-bold shadow animate-pulse">
                            呼吸なし/弱い
                            </button>
                        </div>
                        </div>
                    </div>
                    </div>

                    <div className="bg-white p-4 rounded shadow">
                        <div className="flex items-center justify-between mb-3">
                            <h3 className="font-bold text-slate-700">APGARスコア採点</h3>
                            <div className="flex bg-slate-100 rounded p-1">
                                <button 
                                    onClick={() => setApgarTab('1')}
                                    className={`px-3 py-1 text-xs font-bold rounded ${apgarTab === '1' ? 'bg-white shadow text-blue-600' : 'text-slate-500'}`}
                                >
                                    1分値
                                </button>
                                <button 
                                    onClick={() => setApgarTab('5')}
                                    className={`px-3 py-1 text-xs font-bold rounded ${apgarTab === '5' ? 'bg-white shadow text-blue-600' : 'text-slate-500'}`}
                                >
                                    5分値
                                </button>
                            </div>
                        </div>
                        
                        <ApgarScorer 
                            type={apgarTab} 
                            data={apgarData[apgarTab]} 
                            onChange={handleApgarChange}
                            onSave={handleApgarSave}
                        />
                    </div>
                </div>
            );
        };

        const MotherView = ({ addLog }) => (
            <div className="p-4 space-y-4">
                <div className="bg-pink-50 border-l-4 border-pink-500 p-4 rounded shadow">
                <h3 className="font-bold text-pink-800 mb-2 flex items-center gap-2">
                    <Activity size={20} /> 胎盤・出血管理
                </h3>
                <div className="space-y-3">
                    <button onClick={() => addLog('胎盤娩出完了')} className="w-full bg-white border-2 border-pink-200 text-pink-700 py-3 rounded-lg font-bold shadow hover:bg-pink-100">
                    胎盤 娩出完了
                    </button>
                    <button onClick={() => addLog('子宮底マッサージ開始')} className="w-full bg-pink-600 text-white py-3 rounded-lg font-bold shadow hover:bg-pink-700">
                    子宮底輪状マッサージ
                    </button>
                </div>
                </div>

                <div className="bg-white p-4 rounded shadow space-y-3">
                <h3 className="font-bold text-slate-700">バイタル・観察</h3>
                <div className="grid grid-cols-2 gap-2">
                    <button onClick={() => addLog('母：顔色不良/ショック兆候')} className="bg-slate-100 p-2 rounded text-sm text-left">顔色・意識レベル</button>
                    <button onClick={() => addLog('母：出血量確認')} className="bg-slate-100 p-2 rounded text-sm text-left">出血量チェック</button>
                </div>
                <div className="text-sm text-slate-600 bg-slate-50 p-2 rounded">
                    <strong>ショックインデックス (SI):</strong> 心拍数 ÷ 収縮期血圧 <br/>
                    ※ 1.0以上は要注意（1L以上の出血疑い）
                </div>
                </div>
            </div>
        );

        const LogView = ({ logs }) => (
            <div className="p-4 bg-slate-100 h-64 overflow-y-auto rounded-lg border border-slate-300">
                <h3 className="font-bold text-slate-700 mb-2 sticky top-0 bg-slate-100 pb-2 border-b">活動記録 (Logs)</h3>
                {logs.length === 0 ? (
                <p className="text-slate-400 text-center py-4">記録なし</p>
                ) : (
                <ul className="space-y-2">
                    {logs.map((log, idx) => (
                    <li key={idx} className="text-sm flex justify-between bg-white p-2 rounded shadow-sm">
                        <span className="font-mono font-bold text-slate-500">{log.time}</span>
                        <span className="font-medium text-slate-800">{log.action}</span>
                    </li>
                    ))}
                </ul>
                )}
            </div>
        );

        // --- Main Component ---
        function AmbulanceDeliveryApp() {
            const [activeTab, setActiveTab] = useState('prep'); 
            const [isStopped, setIsStopped] = useState(false);
            const [birthTime, setBirthTime] = useState(null);
            const [currentTime, setCurrentTime] = useState(new Date());
            const [elapsedTime, setElapsedTime] = useState(0); 
            const [logs, setLogs] = useState([]);
            const [checkedItems, setCheckedItems] = useState({});
            const [showResetConfirm, setShowResetConfirm] = useState(false);
            
            // APGAR State: 1分値と5分値をそれぞれ保持
            const initialApgarState = { 
                '1': { skin: null, pulse: null, grimace: null, activity: null, respiration: null },
                '5': { skin: null, pulse: null, grimace: null, activity: null, respiration: null }
            };
            const [apgarData, setApgarData] = useState(initialApgarState);

            // Timer for current time
            useEffect(() => {
                const timer = setInterval(() => setCurrentTime(new Date()), 1000);
                return () => clearInterval(timer);
            }, []);

            // Timer for elapsed time since birth
            useEffect(() => {
                let interval;
                if (birthTime) {
                interval = setInterval(() => {
                    const now = new Date();
                    const diff = Math.floor((now - birthTime) / 1000);
                    setElapsedTime(diff);
                }, 1000);
                }
                return () => clearInterval(interval);
            }, [birthTime]);

            const addLog = (action) => {
                const time = new Date();
                const timeStr = time.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
                setLogs(prev => [{ time: timeStr, action }, ...prev]);
            };

            const handleCheck = (item) => {
                setCheckedItems(prev => {
                const isChecked = !prev[item];
                if (isChecked) {
                    addLog(`準備よし: ${item}`);
                }
                return { ...prev, [item]: isChecked };
                });
            };

            const handleBirth = () => {
                const now = new Date();
                setBirthTime(now);
                addLog('★ 児娩出 (BIRTH)');
                setActiveTab('baby'); 
            };

            // Reset Logic
            const handleResetClick = () => {
                setShowResetConfirm(true);
            };

            const handleConfirmReset = () => {
                setActiveTab('prep');
                setIsStopped(false);
                setBirthTime(null);
                setElapsedTime(0);
                setLogs([]);
                setCheckedItems({});
                setApgarData(initialApgarState); // Reset Apgar
                setShowResetConfirm(false);
            };

            return (
                <div className="max-w-md mx-auto bg-slate-50 min-h-screen flex flex-col font-sans">
                <ResetConfirmModal 
                    isOpen={showResetConfirm}
                    onConfirm={handleConfirmReset}
                    onCancel={() => setShowResetConfirm(false)}
                />
                
                <Header currentTime={currentTime} onResetClick={handleResetClick} />
                <StopAlert isStopped={isStopped} setIsStopped={setIsStopped} addLog={addLog} />

                <main className="flex-1 overflow-y-auto pb-20">
                    {activeTab === 'prep' && (
                    <PrepView 
                        setActiveTab={setActiveTab} 
                        addLog={addLog} 
                        checkedItems={checkedItems} 
                        handleCheck={handleCheck} 
                    />
                    )}
                    {activeTab === 'delivery' && (
                    <DeliveryView 
                        addLog={addLog} 
                        birthTime={birthTime} 
                        handleBirth={handleBirth} 
                        elapsedTime={elapsedTime}
                    />
                    )}
                    {activeTab === 'baby' && (
                    <BabyView 
                        elapsedTime={elapsedTime} 
                        addLog={addLog} 
                        apgarData={apgarData}
                        setApgarData={setApgarData}
                    />
                    )}
                    {activeTab === 'mother' && (
                    <MotherView 
                        addLog={addLog} 
                    />
                    )}
                    
                    <div className="p-4">
                    <LogView logs={logs} />
                    </div>
                </main>

                <div className="fixed bottom-0 w-full max-w-md bg-white border-t border-slate-200 flex shadow-lg z-50 safe-area-bottom">
                    <TabButton id="prep" label="事前準備" icon={CheckSquare} colorClass="bg-orange-600" activeTab={activeTab} setActiveTab={setActiveTab} />
                    <TabButton id="delivery" label="分娩介助" icon={Baby} colorClass="bg-red-600" activeTab={activeTab} setActiveTab={setActiveTab} />
                    <TabButton id="baby" label="新生児" icon={Activity} colorClass="bg-blue-600" activeTab={activeTab} setActiveTab={setActiveTab} />
                    <TabButton id="mother" label="母体" icon={HeartIcon} colorClass="bg-pink-600" activeTab={activeTab} setActiveTab={setActiveTab} />
                </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<AmbulanceDeliveryApp />);
    </script>
</body>
</html>
